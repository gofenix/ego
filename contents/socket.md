---
date: "2019-08-26T06:54:14.652Z"
title: socket
---
# Socket

# 网络模型

## osi七层模型

- 应用层
- 表示层
- 会话层
- 传输层
- 网络层
- 数据链路层
- 物理层

## 对应的tcpip就是

- 应用层
  - dns
  - http
- 传输层
  - icmp
  - tcp
  - udp
- ip层
  - ipv4
  - ipv6
- mac层
  - arp
  - vlan
- 物理层
  - Ethernet

# 为什么要分层

因为网络环境过于复杂，不是一个能够集中控制的体系。全球的服务器和设备各有各的体系，但是可以通过同一套网络协议栈切分成多个层次和组合，来满足不同设备之间的通信需求。

二层到四层，即mac、ip和传输等层都是Linux内核中处理。应用层的如浏览器、Nginx和Tomcat等都是用户态的。

传输层的tcp和udp里都有端口的概念，不同应用监听不同的段即可。

应用层和内核的互通机制，就是通过socket系统调用。其实socket哪一层都不属于，它是属于操作系统的概念，而不是网络分层的概念。因为操作系统把二层到四层的处理代码在内核里，应用层的处理代码让应用自己做，两者需要跨内核态和用户态进行通信，这个就是socket。

# TCP和UDP的区别

- tcp是面向连接的，udp是面向无连接的
- tcp提供可靠交付，无差错、不丢失、不重复、并且按序到达。udp不提供可靠交付，可能丢失，不按顺序。
- tcp是面向字节流的，发送的是一个流，无头无尾。udp是数据报文的，一个一个发送。
- tcp可以提供流量控制和拥塞控制，可以防止对端被压垮，也防止网络被压垮。

**所谓的连接，指两端的数据结构状态的协同，两边状态对的上，符合tcp协议的规则，就认为连接是存在的，否则就是断掉的。**

**所谓的建立连接，其实是为了在客户端和服务端维护连接，而建立一定的数据结构来维护双方交互的状态。并用这样的数据结构来保证面向连接的特性。tcp无法左右中间的任何通路，也没有什么虚拟的连接。**

**所谓的可靠，也是两端的数据结构做的事情。不丢失其实是数据结构在“点名”，顺序到达是数据结构在“排序”，面向数据流其实是数据结构将零散的包，按照顺序捏成一个流发给应用层。**

**所谓的流量控制和拥塞控制，其实就是根据收到的对端的网络包，调整两端的数据结构状态。**

# socket函数

```c
int socket(int domain, int type, int protocol)
```

socket函数用于创建一个socket文件描述符。

- domain
  - 使用什么ip层的协议。AF_INET标识ipv4，AF_INET6标识ipv6。
- type
  - socket的类型。
  - SOCK_STREAM，tcp流的
  - SOCK_DGRAM，udp报文的
  - SOCK_RAW，可以直接操作ip层，或非tcp和udp类型的
- protocol
  - 协议
  - IPPROTO_TCP,  IPPROTO_UDP

![img](/Users/lucas/Documents/Nutstore/assets/997e39e5574252ada22220e4b3646dda.png)


