<html>
    <head>
        <title> 
            openfaas-workshop-lab1b
        </title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.1.0/build/styles/default.min.css"
    />
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.1.0/build/highlight.min.js"></script>

    <script>
      hljs.highlightAll();
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 980px;
        margin: 0 auto;
        padding: 45px;
      }

      @media (max-width: 767px) {
        .markdown-body {
          padding: 15px;
        }
      }
    </style>
    </head>

    <body>
        <div>
            <article class="markdown-body"> 
                <hr class="thin" />
<p>
title: “Openfaas Workshop Lab1b”
date: 2021-03-30T09:55:20+08:00
draft: false
TocOpen: false
draft: false
hidemeta: false
comments: false
description: “Desc Text.”
disableHLJS: true
disableShare: true
disableHLJS: false</p>
<hr class="thin" />
<h1>
实验 1 - 使用 Kubernetes 设置 OpenFaaS</h1>
<img src="https://kubernetes.io/images/kubernetes-horizontal-color.png" width="500px" />
<h2>
安装 <code class="inline">kubectl</code></h2>
<p>
使用下面的说明或<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">官方文档</a>为您的操作系统安装<code class="inline">kubectl</code>。</p>
<ul>
  <li>
Linux  </li>
</ul>
<pre><code class="sh">export VER=$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)
curl -LO https://storage.googleapis.com/kubernetes-release/release/$VER/bin/linux/amd64/kubectl
chmod +x kubectl
mv kubectl /usr/local/bin/</code></pre>
<ul>
  <li>
MacOS  </li>
</ul>
<pre><code class="sh">export VER=$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)
curl -LO https://storage.googleapis.com/kubernetes-release/release/$VER/bin/darwin/amd64/kubectl
chmod +x kubectl
mv kubectl /usr/local/bin/</code></pre>
<ul>
  <li>
Windows  </li>
</ul>
<pre><code class="sh">export VER=$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)
curl -LO https://storage.googleapis.com/kubernetes-release/release/$VER/bin/windows/amd64/kubectl.exe
chmod +x kubectl.exe
mkdir -p $HOME/bin/
mv kubectl $HOME/bin/</code></pre>
<h2>
设置 Kubernetes 集群</h2>
<p>
您可以在使用 Kubernetes 时遵循实验，但您可能需要在此过程中进行一些小的更改。网关的服务地址从<code class="inline">http://gateway:8080</code> 更改为<code class="inline">http://gateway.openfaas:8080</code>。尽可能记录这些差异，并在每个实验室提供替代方案。</p>
<h3>
在笔记本电脑上创建本地集群</h3>
<h4>
<em>k3s 和 k3d</em></h4>
<p>
如果您的计算机上有 Docker，那么您可以使用 Rancher Labs 的 k3d。它安装了一个名为 k3s 的 Kubernetes 轻量级版本，并在 Docker 容器中运行，这意味着它可以在任何有 Docker 的计算机上工作。</p>
<ul>
  <li>
    <p>
<a href="https://github.com/rancher/k3d">安装 k3d</a>    </p>
  </li>
  <li>
    <p>
启动一个集群    </p>
  </li>
</ul>
<ol>
  <li>
<code class="inline">k3d cluster create CLUSTER_NAME</code> 创建一个新的单节点集群 (= 1 个运行 k3s 的容器+1 个负载均衡器容器)  </li>
  <li>
<code class="inline">k3d kubeconfig merge CLUSTER_NAME --switch-context</code> 更新默认的 kubeconfig 并且 切换到当前的上下文。  </li>
  <li>
执行一下命令，比如 <code class="inline">kubectl get pods --all-namespaces</code>
如果你想要删除一个集群 <code class="inline">k3d cluster delete CLUSTER_NAME</code>  </li>
</ol>
<h4>
<em>Docker for Mac</em></h4>
<ul>
  <li>
<a href="https://docs.docker.com/v17.12/docker-for-mac/install/">安装 Docker for Mac</a>  </li>
</ul>
<blockquote>
  <p>
请注意，Kubernetes 仅适用于 Mac 17.12 CE 及更高版本的 Docker  </p>
</blockquote>
<h4>
<em>使用 Minikube</em></h4>
<ul>
  <li>
    <p>
要安装 Minikube，请根据您的平台从 <a href="https://github.com/kubernetes/minikube/releases">latest release</a> 进行下载安装。    </p>
  </li>
  <li>
    <p>
现在通过如下命令启动 Minikube    </p>
  </li>
</ul>
<pre><code>$ minikube start</code></pre>
<p>
Minikube VM 通过一个仅限主机的 IP 地址暴露给主机系统。通过<code class="inline">minikube ip</code>检测这个 IP。
这是稍后将用于网关 URL 的 IP。</p>
<blockquote>
  <p>
注意： Minikube 还需要一个 Hypervisor，如 VirtualBox 或 Hyperkit（在 MacOS 上）。请遵循 Minikube 说明和文档  </p>
</blockquote>
<h3>
在云上创建远程集群</h3>
<p>
您可以在云中创建远程集群，享受与本地开发相同的体验，同时节省 RAM/CPU 和电池。运行集群 1-2 天的成本是最低的。</p>
<h4>
<em>在 DigitalOcean 上运行 Kubernetes 服务</em></h4>
<p>
您可以使用免费学分通过 DigitalOcean 的 UI 创建集群。</p>
<p>
然后，DigitalOcean 的 dashboard 将指导您如何配置用于实验室的<code class="inline">kubectl</code> 和<code class="inline">KUBECONFIG</code> 文件。</p>
<ul>
  <li>
<a href="https://m.do.co/c/8d4e75e9886f">申请您的免费信用-30 天内的 50 美元信用。</a>  </li>
</ul>
<p>
即使您已经申请了免费信用，2-3 个节点集群 24-48 小时的运行成本也是可以忽略不计的。</p>
<ul>
  <li>
    <p>
单击 dashboard 左侧面板的 _Kubernetes_， 然后点击 “Enable Limited Access”    </p>
  </li>
  <li>
    <p>
登录后, 单击 <em>Kubernetes</em> 菜单创建一个集群。    </p>
  </li>
</ul>
<p>
建议使用最新的 Kubernetes 版本和选择最近的数据中心以最大限度地减少延迟。</p>
<ul>
  <li>
在 “Add node pool(s)” 下面  </li>
</ul>
<p>
使用 2x 4GB / 2vCPU</p>
<blockquote>
  <p>
注意：如果需要，您可以在以后添加更多容量。  </p>
</blockquote>
<ul>
  <li>
    <p>
下载 <a href="https://github.com/digitalocean/doctl#installing-doctl">doctl</a> CLI， 并且放到自己的路径下面。    </p>
  </li>
  <li>
    <p>
创建 <a href="https://cloud.digitalocean.com/account/api/tokens/new">API Key</a>    </p>
  </li>
</ul>
<p>
跟踪 API key (复制到剪贴板)</p>
<ul>
  <li>
授权 CLI  </li>
</ul>
<pre><code class="sh">$ doctl auth init</code></pre>
<p>
粘贴 API key</p>
<ul>
  <li>
现在获取集群的名称：  </li>
</ul>
<pre><code class="sh">$ doctl k8s cluster list
GUID    workshop-lon1      nyc1      1.13.5-do.1    provisioning    workshop-lon1-1</code></pre>
<ul>
  <li>
保存一个配置文件， 这样<code class="inline">kubectl</code> 就可以指向一个新集群：  </li>
</ul>
<pre><code class="sh">$ doctl k8s cluster kubeconfig save workshop-lon1</code></pre>
<p>
现在需要将 Kubernetes 上下文切换到指向新集群。</p>
<p>
如果在<code class="inline">kubectl config get-contexts</code>中找不到高亮显示的集群名称，则使用<code class="inline">kubectl config set-context &lt;context-name&gt;</code>。</p>
<h4>
<em>Run on GKE (Google Kubernetes Engine)</em></h4>
<p>
登录谷歌云，创建一个项目并为其启用计费。如果你没有账户，你可以在这里注册<a href="https://cloud.google.com/free/">here</a>。</p>
<p>
安装 <a href="https://cloud.google.com/sdk/docs">Google Cloud SDK</a> - 这将可以使用 <code class="inline">gcloud</code> 和 <code class="inline">kubectl</code> 命令。
对于 windows，请参考 <a href="https://cloud.google.com/sdk/docs/#windows">documentation</a>.</p>
<p>
安装 gcloud 命令之后，通过<code class="inline">gcloud init</code>配置默认项目、计算区域等（将 PROJECT_ID 替换为您自己的项目）。</p>
<pre><code class="sh">$ gcloud config set project PROJECT_ID
$ gcloud config set compute/region us-central1
$ gcloud config set compute/zone us-central1-a</code></pre>
<p>
启用 Kubernetes service:</p>
<pre><code class="sh">$ gcloud services enable container.googleapis.com</code></pre>
<p>
安装 kubectl:</p>
<pre><code class="sh">gcloud components install kubectl</code></pre>
<p>
创建 Kubernetes cluster:</p>
<pre><code class="sh">$ gcloud container clusters create openfaas \
--zone=us-central1-a \
--num-nodes=1 \
--machine-type=n1-standard-2 \
--disk-size=30 \
--no-enable-cloud-logging</code></pre>
<p>
给<code class="inline">kubectl</code>设置 credentials:</p>
<pre><code class="sh">$ gcloud container clusters get-credentials openfaas</code></pre>
<p>
创建一个集群管理员：</p>
<pre><code class="sh">$ kubectl create clusterrolebinding &quot;cluster-admin-$(whoami)&quot; \
--clusterrole=cluster-admin \
--user=&quot;$(gcloud config get-value core/account)&quot;</code></pre>
<p>
现在验证 <code class="inline">kubectl</code> 已经被配置到了 GKE 集群：</p>
<pre><code>$ kubectl get nodes
NAME                                   STATUS    ROLES     AGE       VERSION
gke-name-default-pool-eceef152-qjmt   Ready     &lt;none&gt;    1h        v1.10.7-gke.2</code></pre>
<h2>
部署 OpenFaaS</h2>
<p>
部署 OpenFaaS 的说明会不时更改，因为我们努力让这变得更容易。</p>
<h3>
安装 OpenFaaS</h3>
<p>
有三种安装 OpenFaaS 的方法，您可以选择对您和您的团队有意义的方法。在这个研讨会中，我们将使用官方安装程序<code class="inline">arkade</code>。</p>
<ul>
  <li>
    <p>
<code class="inline">arkade 应用安装</code> - arkade 使用官方的 helm chart 安装 OpenFaaS。 它还可以提供其他具有用户友好型 CLI 的软件，比如 <code class="inline">cert-manager</code> 和 <code class="inline">nginx-ingress</code>。 这是启动和运行的最简单、最快的方法。    </p>
  </li>
  <li>
    <p>
Helm chart - 易于通过 YAML 或 CLI 标志进行配置。对于那些在限制性环境中工作的人来说，也存在安全选项， 比如 <code class="inline">helm template</code> 或 <code class="inline">helm 3</code>。    </p>
  </li>
  <li>
    <p>
普通 YAML 文件 - 硬编码 settings/values。如 Kustomise 可以提供自定义设置。    </p>
  </li>
</ul>
<h4>
<code class="inline">arkade</code></h4>
<ul>
  <li>
获取 arkade  </li>
</ul>
<p>
For MacOS / Linux:</p>
<pre><code class="sh">curl -SLsf https://dl.get-arkade.dev/ | sudo sh</code></pre>
<p>
For Windows:</p>
<pre><code class="sh">curl -SLsf https://dl.get-arkade.dev/ | sh</code></pre>
<ul>
  <li>
安装 OpenFaaS  </li>
</ul>
<p>
如果使用提供负载均衡器的托管云 Kubernetes 服务，则运行以下操作：</p>
<pre><code class="sh">arkade install openfaas --load-balancer</code></pre>
<blockquote>
  <p>
注意：’–load-balancer’标志默认为<code class="inline">false</code>，因此需要通过传递该标志给云厂商。  </p>
</blockquote>
<p>
如果使用本地 Kubernetes 群集或 VM，请运行：</p>
<pre><code class="sh">arkade install openfaas</code></pre>
<h4>
helm (高级)</h4>
<p>
如果您愿意，您可以使用[ <a href="https://github.com/openfaas/faas-netes/blob/master/chart/openfaas/README.md">helm chart</a>。</p>
<h3>
登录 OpenFaaS gateway</h3>
<ul>
  <li>
检查 gateway 已经可用  </li>
</ul>
<pre><code class="sh">kubectl rollout status -n openfaas deploy/gateway</code></pre>
<p>
如果您使用的是笔记本电脑、VM 或任何其他类型的 Kubernetes 发行版，请改为运行以下内容：</p>
<pre><code class="sh">kubectl port-forward svc/gateway -n openfaas 8080:8080</code></pre>
<p>
此命令将打开一条从 Kubernetes 集群到本地计算机的隧道，以便您可以访问 OpenFaaS 网关。还有其他方法可以访问 OpenFaaS，但这超出了本研讨会的范围。</p>
<p>
Gateway URL 是： <code class="inline">http://127.0.0.1:8080</code></p>
<p>
如果使用托管云 Kubernetes 服务，则从下面的命令中的<code class="inline">EXTERNAL-IP</code> 字段获取 LoadBalancer 的 IP 地址或 DNS 地址。</p>
<pre><code class="sh">kubectl get svc -o wide gateway-external -n openfaas</code></pre>
<ul>
  <li>
登录：  </li>
</ul>
<pre><code class="sh">export OPENFAAS_URL=&quot;&quot; # Populate as above

# This command retrieves your password
PASSWORD=$(kubectl get secret -n openfaas basic-auth -o jsonpath=&quot;{.data.basic-auth-password}&quot; | base64 --decode; echo)

# This command logs in and saves a file to ~/.openfaas/config.yml
echo -n $PASSWORD | faas-cli login --username admin --password-stdin</code></pre>
<ul>
  <li>
检查 <code class="inline">faas-cli list</code>：  </li>
</ul>
<pre><code class="sh">faas-cli list</code></pre>
<h3>
永久保存您的 OpenFaaS URL</h3>
<p>
编辑 <code class="inline">~/.bashrc</code> or <code class="inline">~/.bash_profile</code> 。</p>
<p>
现在添加以下内容——根据上面看到的内容更改 URL 地址。</p>
<pre><code class="sh">export OPENFAAS_URL=&quot;&quot; # populate as above</code></pre>
<p>
现在进入 <a href="lab2.md">实验 2</a></p>

            </article>
        </div>
    </body>
</html>

    