<html>
    <head>
        <title> 
            parity
        </title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.1.0/build/styles/default.min.css"
    />
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.1.0/build/highlight.min.js"></script>

    <script>
      hljs.highlightAll();
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 980px;
        margin: 0 auto;
        padding: 45px;
      }

      @media (max-width: 767px) {
        .markdown-body {
          padding: 15px;
        }
      }
    </style>
    </head>

    <body>
        <div>
            <article class="markdown-body"> 
                <hr class="thin" />
<p>
date: “2018-08-22 16:51:13”
title: 基于以太坊的Parity联盟链部署</p>
<hr class="thin" />
<p>
公司项目中使用公网上的以太坊私链，交易速度比较慢，于是这几天都在鼓捣基于以太坊的联盟链，parity是可以构建出一个基于PoA共识的私链，而且兼容以太坊的合约。这篇文章主要是记录自己的踩坑经历，主要实现了节点的搭建，合约的部署以及本地以太坊浏览器的启动。</p>
<h2>
部署联盟链</h2>
<p>
parity的文档：<a href="https://wiki.parity.io/Demo-PoA-tutorial">https://wiki.parity.io/Demo-PoA-tutorial</a></p>
<h3>
安装</h3>
<p>
首先是下载parity，在mac下是直接brew安装即可。</p>
<pre><code>brew tap paritytech/paritytech

brew install parity</code></pre>
<h3>
创世区块</h3>
<p>
创世区块的配置文件：</p>
<pre><code class="on">// demo-spec.json

{
  &quot;name&quot;: &quot;DemoPoA&quot;,
  &quot;engine&quot;: {
    &quot;authorityRound&quot;: {
      &quot;params&quot;: {
        &quot;stepDuration&quot;: &quot;5&quot;,
        &quot;validators&quot;: {
          &quot;list&quot;: [
            &quot;0x00bd138abd70e2f00903268f3db08f2d25677c9e&quot;,
            &quot;0x00aa39d30f0d20ff03a22ccfc30b7efbfca597c2&quot;
          ]
        }
      }
    }
  },
  &quot;params&quot;: {
    &quot;gasLimitBoundDivisor&quot;: &quot;0x400&quot;,
    &quot;maximumExtraDataSize&quot;: &quot;0x20&quot;,
    &quot;minGasLimit&quot;: &quot;0x1388&quot;,
    &quot;networkID&quot;: &quot;0x2323&quot;,
    &quot;eip155Transition&quot;: 0,
    &quot;validateChainIdTransition&quot;: 0,
    &quot;eip140Transition&quot;: 0,
    &quot;eip211Transition&quot;: 0,
    &quot;eip214Transition&quot;: 0,
    &quot;eip658Transition&quot;: 0
  },
  &quot;genesis&quot;: {
    &quot;seal&quot;: {
      &quot;authorityRound&quot;: {
        &quot;step&quot;: &quot;0x0&quot;,
        &quot;signature&quot;: &quot;0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;
      }
    },
    &quot;difficulty&quot;: &quot;0x20000&quot;,
    &quot;gasLimit&quot;: &quot;0x5B8D80&quot;
  },
  &quot;accounts&quot;: {
    &quot;0x0000000000000000000000000000000000000001&quot;: {
      &quot;balance&quot;: &quot;1&quot;,
      &quot;builtin&quot;: {
        &quot;name&quot;: &quot;ecrecover&quot;,
        &quot;pricing&quot;: { &quot;linear&quot;: { &quot;base&quot;: 3000, &quot;word&quot;: 0 } }
      }
    },
    &quot;0x0000000000000000000000000000000000000002&quot;: {
      &quot;balance&quot;: &quot;1&quot;,
      &quot;builtin&quot;: {
        &quot;name&quot;: &quot;sha256&quot;,
        &quot;pricing&quot;: { &quot;linear&quot;: { &quot;base&quot;: 60, &quot;word&quot;: 12 } }
      }
    },
    &quot;0x0000000000000000000000000000000000000003&quot;: {
      &quot;balance&quot;: &quot;1&quot;,
      &quot;builtin&quot;: {
        &quot;name&quot;: &quot;ripemd160&quot;,
        &quot;pricing&quot;: { &quot;linear&quot;: { &quot;base&quot;: 600, &quot;word&quot;: 120 } }
      }
    },
    &quot;0x0000000000000000000000000000000000000004&quot;: {
      &quot;balance&quot;: &quot;1&quot;,
      &quot;builtin&quot;: {
        &quot;name&quot;: &quot;identity&quot;,
        &quot;pricing&quot;: { &quot;linear&quot;: { &quot;base&quot;: 15, &quot;word&quot;: 3 } }
      }
    },
    &quot;0x004ec07d2329997267ec62b4166639513386f32e&quot;: {
      &quot;balance&quot;: &quot;10000000000000000000000&quot;
    }
  }
}</code></pre>
<h3>
node0</h3>
<p>
node0节点：</p>
<pre><code class="toml">## node0.toml

[parity]
chain = &quot;demo-spec.json&quot;
base_path = &quot;parity0&quot;

[network]
port = 30300

[rpc]
port = 8546
apis = [&quot;web3&quot;, &quot;eth&quot;, &quot;net&quot;, &quot;personal&quot;, &quot;parity&quot;, &quot;parity_set&quot;, &quot;traces&quot;, &quot;rpc&quot;, &quot;parity_accounts&quot;]
interface = &quot;0.0.0.0&quot;
cors = [&quot;*&quot;]
hosts = [&quot;all&quot;]


[websockets]
port = 8456


[account]
password = [&quot;node.pwds&quot;]


[mining]
engine_signer = &quot;0x00bd138abd70e2f00903268f3db08f2d25677c9e&quot;
reseal_on_txs = &quot;none&quot;
</code></pre>
<h3>
node1</h3>
<p>
node1节点：</p>
<pre><code class="toml">## node1.toml

[parity]
chain = &quot;demo-spec.json&quot;
base_path = &quot;parity1&quot;


[network]
port = 30301


[rpc]
port = 8541
apis = [&quot;web3&quot;, &quot;eth&quot;, &quot;net&quot;, &quot;personal&quot;, &quot;parity&quot;, &quot;parity_set&quot;, &quot;traces&quot;, &quot;rpc&quot;, &quot;parity_accounts&quot;]



[websockets]
port = 8451


[ipc]
disable = true


[account]
password = [&quot;node.pwds&quot;]


[mining]
engine_signer = &quot;0x00aa39d30f0d20ff03a22ccfc30b7efbfca597c2&quot;
reseal_on_txs = &quot;none&quot;


[ui]
disable = true</code></pre>
<h3>
启动并创建账户</h3>
<p>
启动</p>
<pre><code>parity --config node0.toml --fat-db=on
parity --config node1.toml --fat-db=on</code></pre>
<p>
创建账户：</p>
<pre><code>curl --data &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;parity_newAccountFromPhrase&quot;,&quot;params&quot;:[&quot;node0&quot;, &quot;node0&quot;],&quot;id&quot;:0}&#39; -H &quot;Content-Type: application/json&quot; -X POST localhost:8546</code></pre>
<pre><code>curl --data &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;parity_newAccountFromPhrase&quot;,&quot;params&quot;:[&quot;user&quot;, &quot;user&quot;],&quot;id&quot;:0}&#39; -H &quot;Content-Type: application/json&quot; -X POST localhost:8546</code></pre>
<pre><code>curl --data &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;parity_newAccountFromPhrase&quot;,&quot;params&quot;:[&quot;node1&quot;, &quot;node1&quot;],&quot;id&quot;:0}&#39; -H &quot;Content-Type: application/json&quot; -X POST localhost:8541</code></pre>
<p>
这样就创建了3个账户，其中node0和node1是见证者  user是初始发钱的。</p>
<p>
因为parity ui是要连接8546端口，所以这里就让node0的rpc的端口是8546。</p>
<h3>
节点互通和转账</h3>
<p>
让node0和node1节点相通，其实就是让两个节点成为一个网络：</p>
<pre><code>// 获取node0的encode
curl --data &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;parity_enode&quot;,&quot;params&quot;:[],&quot;id&quot;:0}&#39; -H &quot;Content-Type: application/json&quot; -X POST localhost:8546

// 调用node1的rpc，将node0加入， RESULT就是上一步获取的
curl --data &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;parity_addReservedPeer&quot;,&quot;params&quot;:[&quot;enode://RESULT&quot;],&quot;id&quot;:0}&#39; -H &quot;Content-Type: application/json&quot; -X POST localhost:8541</code></pre>
<p>
我们先给两个账户转账：</p>
<pre><code>curl --data &#39;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;method&quot;:&quot;personal_sendTransaction&quot;,&quot;params&quot;:[{&quot;from&quot;:&quot;0x004ec07d2329997267Ec62b4166639513386F32e&quot;,&quot;to&quot;:&quot;0x00Bd138aBD70e2F00903268F3Db08f2D25677C9e&quot;,&quot;value&quot;:&quot;0xde0b6b3a7640000&quot;}, &quot;user&quot;],&quot;id&quot;:0}&#39; -H &quot;Content-Type: application/json&quot; -X POST localhost:8540</code></pre>
<p>
从user中转了1个以太坊到了node0账户中，同样再转给node1。</p>
<h2>
部署合约</h2>
<p>
再使用truffle开发完合约之后，把账户部署到我们刚刚起来的联盟链。部署合约需要消耗一定的gas，truffle使用的是HD wallet的Provider，所以我们要先给一个钱包转一些以太币。</p>
<p>
因为这里用的是metamask，在最初创建钱包的时候有设置12个助记词，所以先让钱包连接到node0节点：</p>
<p>
  <img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fuioo9rlayj30ab0h2gne.jpg" alt="" />
</p>
<p>
创建一个账户，向那个账户转几个以太币。</p>
<p>
然后在truffle中，配置如下：</p>
<pre><code>// truffle.js

module.exports = {
  // See &lt;http://truffleframework.com/docs/advanced/configuration&gt;
  // to customize your Truffle configuration!
  networks: {
    development: {
      host: &quot;127.0.0.1&quot;,
      port: 8545,
      network_id: &quot;*&quot;
    },
    parity: {
      provider: function () {
        return new HDWalletProvider(&#39;这里写助记词&#39;, &quot;http://127.0.0.1:8546&quot;)
      },
      network_id: 3,
      gas: 4700000
    }
  }
};</code></pre>
<p>
然后在执行部署合约的时候，指定parity即可：</p>
<pre><code>truffle migrate --network parity</code></pre>
<h2>
部署以太坊浏览器</h2>
<p>
以太坊的浏览器找了好几个，最后选中了<a href="https://github.com/gobitfly/etherchain-light">etherchain-light</a>。部署起来简单。</p>
<p>
首先clone代码到本地，然后npm安装依赖。</p>
<pre><code>git clone https://github.com/gobitfly/etherchain-light --recursive

cd etherchain-light &amp;&amp; yarn</code></pre>
<p>
一定要用<code class="inline">—-recursive</code>，将所有git的子模块都下载下来。</p>
<p>
修改config.js.example文件为config.js，然后把Provider改为HttpProvider，连接到node0的节点即可。</p>
<pre><code>// config.js
var web3 = require(&#39;web3&#39;);
var net = require(&#39;net&#39;);

var config = function () {
  
  this.logFormat = &quot;combined&quot;;
  // this.ipcPath = process.env[&quot;HOME&quot;] + &quot;/.local/share/io.parity.ethereum/jsonrpc.ipc&quot;;
  // this.provider = new web3.providers.IpcProvider(this.ipcPath, net);

  this.provider = new web3.providers.HttpProvider(&quot;http://127.0.0.1:8546&quot;)
  
  // ... 省略其余代码
}

module.exports = config;</code></pre>
<p>
执行<code class="inline">npm start</code>之后即可将以太坊浏览器运行起来。然后在浏览器中访问<code class="inline">http://localhost:3000</code>。</p>
<h2>
思考</h2>
<p>
PoA共识基于权威的共识机制，和基于raft协议的共识机制具体哪个更快？</p>
<p>
Parity文档中没有找到和权限控制相关的模块，用它来做联盟链还有待确定。</p>
<p>
Quorum是JP摩根开源的基于以太坊的联盟链，使用的raft算法，可以研究研究。</p>
<p>
还不是很清楚，fabric已经是联盟链主流的情况下，选择以太坊做联盟链的好处有多大。</p>

            </article>
        </div>
    </body>
</html>

    