<html>
    <head>
        <title> 
            openfaas-workshop-lab3
        </title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.1.0/build/styles/default.min.css"
    />
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.1.0/build/highlight.min.js"></script>

    <script>
      hljs.highlightAll();
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 980px;
        margin: 0 auto;
        padding: 45px;
      }

      @media (max-width: 767px) {
        .markdown-body {
          padding: 15px;
        }
      }
    </style>
    </head>

    <body>
        <div>
            <article class="markdown-body"> 
                <hr class="thin" />
<p>
date: “2018-06-28 17:29:56”
title: openfaas-workshop-lab3</p>
<hr class="thin" />
<h1>
Lab3 - 函数的介绍</h1>
<img src="https://github.com/openfaas/media/raw/master/OpenFaaS_Magnet_3_1_png.png" width="500px" />
<p>
在开始本实验之前，创建一个新文件夹：</p>
<pre><code>$ mkdir -p lab3 \
   &amp;&amp; cd lab3</code></pre>
<h2>
创建一个新函数</h2>
<p>
创建函数有两种方式：</p>
<ul>
  <li>
使用内置的或社区提供的代码末班创建一个函数脚手架（默认）  </li>
</ul>
<ul>
  <li>
将现有的二进制文件作为函数（高级）  </li>
</ul>
<h3>
生成一个新函数</h3>
<p>
在使用模板创建一个新函数之前，首先确认你已经从 Github 上拉下来<a href="https://github.com/openfaas/templates">模板文件</a>：</p>
<pre><code>$ faas-cli template pull

Fetch templates from repository: https://github.com/openfaas/templates.git
 Attempting to expand templates from https://github.com/openfaas/templates.git
 Fetched 11 template(s) : [csharp dockerfile go go-armhf node node-arm64 node-armhf python python-armhf python3 ruby]</code></pre>
<p>
之后找到可用的语言：</p>
<pre><code>$ faas-cli new --list
Languages available as templates:
- csharp
- dockerfile
- go
- go-armhf
- node
- node-arm64
- node-armhf
- python
- python-armhf
- python3
- ruby

Or alternatively create a folder containing a Dockerfile, then pick
the &quot;Dockerfile&quot; lang type in your YAML file.</code></pre>
<p>
此时你可以创建 Python, Python 3, Ruby, Go, Node, CSharp 等函数。</p>
<ul>
  <li>
关于我们例子的说明  </li>
</ul>
<p>
在这个 workshop 中的所有例子都已经被 OpenFaas 社区使用 Python3 测试通过，应该也兼容 Python2.7。</p>
<p>
如果你倾向于 Python2.7 而不是 Python3，使用<code class="inline">faas-cli new --lang python</code>命令替换<code class="inline">faas-cli new --lang python3</code>。</p>
<h3>
Python 里的 Hello World</h3>
<p>
我们将会用 Python 创建一个 hello-world 函数，然后也会学习附加的依赖项。</p>
<ul>
  <li>
函数脚手架  </li>
</ul>
<pre><code>$ faas-cli new --lang python3 hello-openfaas --prefix=&quot;&lt;your-docker-username-here&gt;&quot;</code></pre>
<p>
—prefix 参数将会把<code class="inline">hello-openfaas.yml</code>文件里<code class="inline">image:</code> 变量中的 prefix 更新为你的 docker hub 的账户。OpenFaas 的镜像<code class="inline">image: functions/hello-openfaas</code>里的参数将会是<code class="inline">--prefix=&quot;functions&quot;</code>。</p>
<p>
如果你不想指定 prefix，那么在创建函数之后可以通过修改 YAML 文件。</p>
<p>
这将会在文件夹中创建 3 个文件：</p>
<pre><code>./hello-openfaas.yml
./hello-openfaas
./hello-openfaas/handler.py
./hello-openfaas/requirements.txt</code></pre>
<p>
YAML(.yml)文件用于配置 CLI 的构建，推送和部署。</p>
<blockquote>
  <p>
说明：无论何时你需要在 Kubernetes 或远程 OpenFaaS 实例部署一个函数时，都必须在你构建之后。  </p>
  <p>
在这个例子中，你也可以通过设置一个环境变量：<code class="inline">export OPENFAAS_URL=127.0.0.1:31112</code>覆盖掉默认的网关 URL：127.0.0.1：8080，  </p>
</blockquote>
<p>
如下是 YAML 文件的内容：</p>
<pre><code class="yaml">provider:
  name: faas
  gateway: http://127.0.0.1:8080

functions:
  hello-openfaas:
    lang: python3
    handler: ./hello-openfaas
    image: hello-openfaas</code></pre>
<ul>
  <li>
函数的名字是在<code class="inline">functions</code>的下面，如：<code class="inline">hello-openfaas</code>  </li>
</ul>
<ul>
  <li>
    <p>
语言是放在 lang 之下    </p>
  </li>
  <li>
    <p>
handler 是用于构建的文件夹，一定得是文件夹，不能是文件    </p>
  </li>
  <li>
    <p>
docker 的镜像名是放在 image 之下    </p>
  </li>
</ul>
<p>
请记住，网关的 URL 是可以在 YAML 文件中 provider 下的 gateway 字段覆写，或者是在 CLI 中使用—gateway 参数或是环境变量的的 OPENFAAS_URL。</p>
<p>
如下是<code class="inline">handler.py</code>文件的内容：</p>
<pre><code>def handle(req):
    &quot;&quot;&quot;handle a request to the function
    Args:
        req (str): request body
    &quot;&quot;&quot;

    return req</code></pre>
<p>
这个函数返回输入的值，和 echo 函数很像。</p>
<p>
将返回值修改为<code class="inline">Hello OpenFaaS</code>，如：</p>
<pre><code>    return &quot;Hello OpenFaaS&quot;</code></pre>
<p>
任何返回给标准输出的值随后都会被返回给调用的程序。或者说是一个 print()语句和显示的结果和调用的程序流程相似。</p>
<p>
这是本地的开发流程：</p>
<pre><code>$ faas-cli build -f ./hello-openfaas.yml
$ faas-cli push -f ./hello-openfaas.yml
$ faas-cli deploy -f ./hello-openfaas.yml</code></pre>
<p>
接下来通过 UI，CLI，curk 或者其他的程序去调用函数。</p>
<p>
这些函数都会被分配一个路由，比如：</p>
<pre><code>http://127.0.0.1:8080/function/&lt;function_name&gt;
http://127.0.0.1:8080/function/figlet
http://127.0.0.1:8080/function/hello-openfaas</code></pre>
<blockquote>
  <p>
专家提醒：如果你重命名了 YAML 文件为 stack.yml，不再需要是用-f 参数。  </p>
</blockquote>
<p>
函数只能被 get 或 post 方法调用。</p>
<ul>
  <li>
调用你的函数  </li>
</ul>
<p>
使用 faas-cli invoke 测试函数，更多的命令请参考 faas-cli invoke –help</p>
<h3>
例子：发现宇航员</h3>
<p>
我们将会创建一个叫 astronaut-finder 函数，这个函数会从国际空间站上拉取一个随机的宇航员的名字。</p>
<pre><code>$ faas-cli new --lang python3 astronaut-finder --prefix=&quot;&lt;your-docker-username-here&gt;&quot;</code></pre>
<p>
这会为我们创建三个文件：</p>
<pre><code>./astronaut-finder/handler.py</code></pre>
<p>
该函数的 handler —— 你会得到一个原始的请求 req 对象，而且会在控制台上打印结果。</p>
<pre><code>./astronaut-finder/requirements.txt</code></pre>
<p>
在这个文件中列出你想要安装的 pip 模块，比如 requests 或 urllib</p>
<pre><code>./astronaut-finder.yml</code></pre>
<p>
这个文件用于管理函数——在里面有函数名，docker 镜像和其他自定义的字段。</p>
<ul>
  <li>
Edit <code class="inline">./astronaut-finder/requirements.txt</code>  </li>
  <li>
修改<code class="inline">./astronaut-finder/requirements.txt</code>  </li>
</ul>
<pre><code>requests</code></pre>
<p>
这告诉函数，他需要使用一个名叫 requests 的第三方包用于使用 http 请求网站。</p>
<ul>
  <li>
写函数代码：  </li>
</ul>
<p>
我们将会从 <a href="http://api.open-notify.org/astros.json%E6%8B%89%E5%8F%96%E6%95%B0%E6%8D%AE">http://api.open-notify.org/astros.json拉取数据</a></p>
<p>
这是返回结果的例子：</p>
<pre><code class="on">{
  &quot;number&quot;: 6,
  &quot;people&quot;: [
    { &quot;craft&quot;: &quot;ISS&quot;, &quot;name&quot;: &quot;Alexander Misurkin&quot; },
    { &quot;craft&quot;: &quot;ISS&quot;, &quot;name&quot;: &quot;Mark Vande Hei&quot; },
    { &quot;craft&quot;: &quot;ISS&quot;, &quot;name&quot;: &quot;Joe Acaba&quot; },
    { &quot;craft&quot;: &quot;ISS&quot;, &quot;name&quot;: &quot;Anton Shkaplerov&quot; },
    { &quot;craft&quot;: &quot;ISS&quot;, &quot;name&quot;: &quot;Scott Tingle&quot; },
    { &quot;craft&quot;: &quot;ISS&quot;, &quot;name&quot;: &quot;Norishige Kanai&quot; }
  ],
  &quot;message&quot;: &quot;success&quot;
}</code></pre>
<p>
更新 handler.py：</p>
<pre><code>import requests
import random

def handle(req):
    r = requests.get(&quot;http://api.open-notify.org/astros.json&quot;)
    result = r.json()
    index = random.randint(0, len(result[&quot;people&quot;])-1)
    name = result[&quot;people&quot;][index][&quot;name&quot;]

    return &quot;%s is in space&quot; % (name)</code></pre>
<blockquote>
  <p>
备注：在这个例子中我们不需要使用 req 参数，但是必须确保他在函数头里。  </p>
</blockquote>
<p>
现在构建函数：</p>
<pre><code>$ faas-cli build -f ./astronaut-finder.yml</code></pre>
<blockquote>
  <p>
提示：试着将 astronaut-finder.yml 重命名为 stack.yml，然后就可以使用 faas-cli build。  </p>
  <p>
stack.yml 是 CLI 的默认命名。  </p>
</blockquote>
<p>
部署函数：</p>
<pre><code>$ faas-cli deploy -f ./astronaut-finder.yml</code></pre>
<p>
调用函数</p>
<pre><code>$ echo | faas-cli invoke astronaut-finder
Anton Shkaplerov is in space

$ echo | faas-cli invoke astronaut-finder
Joe Acaba is in space</code></pre>
<h2>
故障排除：找到容器的日志</h2>
<p>
通过容器的日志你可以找到函数每次调用的高级别的信息：</p>
<pre><code>$ docker service logs -f astronaut-finder
astronaut-finder.1.1e1ujtsijf6b@nuc    | 2018/02/21 14:53:25 Forking fprocess.
astronaut-finder.1.1e1ujtsijf6b@nuc    | 2018/02/21 14:53:26 Wrote 18 Bytes - Duration: 0.063269 seconds</code></pre>
<h2>
故障排除：使用 write_debug 详细输出</h2>
<p>
让我们打开函数的详细输出。为了不让函数的日志和数据泛滥，这个功能默认是关闭的，在日志里有很多没有意义的二进制数据时，这点儿尤为重要。</p>
<p>
这是标准的 YAML 配置：</p>
<pre><code class="yaml">provider:
  name: faas
  gateway: http://127.0.0.1:8080

functions:
  astronaut-finder:
    lang: python3
    handler: ./astronaut-finder
    image: astronaut-finder</code></pre>
<p>
编辑 YAML 文件，添加 environment。</p>
<pre><code class="yaml">  astronaut-finder:
    lang: python3
    handler: ./astronaut-finder
    image: astronaut-finder
    environment:
      write_debug: true</code></pre>
<p>
现在再次使用<code class="inline">faas-cli deploy -f ./astronaut-finder.yml</code>部署。</p>
<p>
调用函数，然后观察函数的返回：</p>
<pre><code>$ docker service logs -f astronaut-finder
astronaut-finder.1.1e1ujtsijf6b@nuc    | 2018/02/21 14:53:25 Forking fprocess.
astronaut-finder.1.szobw9pt3m60@nuc    | 2018/02/26 14:49:57 Query  
astronaut-finder.1.szobw9pt3m60@nuc    | 2018/02/26 14:49:57 Path  /function/hello-openfaas
astronaut-finder.1.1e1ujtsijf6b@nuc    | 2018/02/21 14:53:26 Hello World
astronaut-finder.1.1e1ujtsijf6b@nuc    | 2018/02/21 14:53:26 Duration: 0.063269 seconds</code></pre>
<h3>
管理多个函数</h3>
<p>
CLI 的 YAML 文件也可以把函数打组为一个 stack 里，当在几个相关联的函数工作时是很有用的。</p>
<p>
看一下如何生成两个函数：</p>
<pre><code>$ faas-cli new --lang python3 first</code></pre>
<p>
第二个函数使用–apend 标志：</p>
<pre><code>$ faas-cli new --lang python3 second --append=./first.yml</code></pre>
<p>
为了方便我们把 first.yml 重命名为 example.yml。</p>
<pre><code>$ mv first.yml example.yml</code></pre>
<p>
现在看一下文件：</p>
<pre><code>provider:
  name: faas
  gateway: http://127.0.0.1:8080

functions:
  first:
    lang: python3
    handler: ./first
    image: first
  second:
    lang: python3
    handler: ./second
    image: second</code></pre>
<p>
当一个函数栈工作时，这里有几个有用的标志。</p>
<ul>
  <li>
并行构建  </li>
</ul>
<pre><code class="sh">$ faas-cli build -f ./example.yml --parallel=2</code></pre>
<ul>
  <li>
只构建或者推送一个函数  </li>
</ul>
<pre><code class="sh">$ faas-cli build -f ./example.yml --filter=second</code></pre>
<p>
更多信息请参考<code class="inline">faas-cli build --help</code> 和 <code class="inline">faas-cli push --help</code> 。</p>
<blockquote>
  <p>
专家提醒：如果你不想传-f 参数，faas-cli 将会自动寻找 stack.yml 文件。  </p>
</blockquote>
<p>
你也可以在使用<code class="inline">faas-cli -f https://....</code>将函数栈部署在 https 上。</p>
<h3>
使用自定义模板</h3>
<p>
如果你有自己的语言模板或者是从社区中找到的模板，比如 PHP。你可以使用下面的命令添加进来：</p>
<pre><code>$ faas-cli template pull https://github.com/itscaro/openfaas-template-php

...

$ faas-cli new --list | grep php
- php
- php5</code></pre>
<p>
社区模板列表维护在<a href="https://github.com/openfaas/faas-cli">OpenFaaS CLI README</a>页面。</p>
<p>
继续可选的练习或者进入 <a href="lab4.md">Lab 4</a>。</p>
<h3>
自定义二进制文件为函数（可选）</h3>
<p>
自定义二进制文件或者容器也可以被作为函数，但是大部分时间里使用语言模板文件应该可以涵盖大多数情况。</p>
<p>
通过使用 dockerfile 语言，可以用自定义二进制或者 Dockerfile 创建一个新函数函数：</p>
<pre><code>$ faas-cli new --lang dockerfile sorter --prefix=&quot;&lt;your-docker-username-here&gt;&quot;</code></pre>
<p>
你将会看到 sorter 文件夹和 sorter.yml 文件被创建。</p>
<p>
编辑 sorter/Docerfile，更新设置 fprocess 的那一行。让我们改变他为内置 bash 的 sort 命令。我们可以用这个命令对字符串按照字母数字顺序排序。</p>
<pre><code>ENV fprocess=&quot;sort&quot;</code></pre>
<p>
构建，推送和部署函数：</p>
<pre><code>$ faas-cli build -f sorter.yml \
  &amp;&amp; faas-cli push -f sorter.yml \
  &amp;&amp; faas-cli deploy -f sorter.yml</code></pre>
<p>
从 UI 或者 CLI 中调用函数：</p>
<pre><code>$ echo -n &#39;
elephant
zebra
horse
ardvark
monkey&#39;| faas-cli invoke sorter

ardvark
elephant
horse
monkey
zebra</code></pre>
<p>
在这个例子中我们使用内置于 BusyBox 的 sort 命令。也有其他有用的命令，比如 sha512sum，甚至可以是 bash 或者 shell 脚本，而且并不限制于这些命令。任何二进制或者存在的容器都可以通过添加到 OpenFaaS 的函数 watchdog 中来将它 serverless 化。</p>
<blockquote>
  <p>
提示：你知道 OpenFaaS 也支持 WIndows 的二进制文件吗？比如 C#，VB 或者 PowerShell？  </p>
</blockquote>
<p>
现在进入 <a href="lab4.md">Lab 4</a></p>

            </article>
        </div>
    </body>
</html>

    