<html>
    <head>
        <title> 
            openfaas-workshop-lab2
        </title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.1.0/build/styles/default.min.css"
    />
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.1.0/build/highlight.min.js"></script>

    <script>
      hljs.highlightAll();
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 980px;
        margin: 0 auto;
        padding: 45px;
      }

      @media (max-width: 767px) {
        .markdown-body {
          padding: 15px;
        }
      }
    </style>
    </head>

    <body>
        <div>
            <article class="markdown-body"> 
                <hr class="thin" />
<p>
title: “Openfaas Workshop Lab2”
date: 2021-03-30T09:57:01+08:00
draft: false
TocOpen: false
draft: false
hidemeta: false
comments: false
description: “Desc Text.”
disableHLJS: true
disableShare: true
disableHLJS: false</p>
<hr class="thin" />
<h1>
实验 2 - 测试</h1>
<img src="https://github.com/openfaas/media/raw/master/OpenFaaS_Magnet_3_1_png.png" width="500px" />
<p>
在开始实验之前，先创建一个文件夹：</p>
<pre><code class="sh">$ mkdir -p lab2 \
   &amp;&amp; cd lab2</code></pre>
<h2>
使用 UI 门户</h2>
<p>
您现在可以测试 OpenFaaS UI：</p>
<p>
如果你已经设置了 <code class="inline">$OPENFAAS_URL</code> ，请获取 URL，并点开:</p>
<pre><code class="sh">echo $OPENFAAS_URL
http://127.0.0.1:31112</code></pre>
<p>
如果还没有设置 <code class="inline">$OPENFAAS_URL</code> ，那么默认的值通常是： <a href="http://127.0.0.1:8080">http://127.0.0.1:8080</a>.</p>
<p>
我们可以部署一些示例函数，然后使用它们进行测试：</p>
<pre><code class="sh">$ faas-cli deploy -f https://raw.githubusercontent.com/openfaas/faas/master/stack.yml</code></pre>
<p>
  <img src="./screenshot/markdown_portal.png" alt="" />
</p>
<p>
您可以在用户界面中试用它们，例如 Markdown 函数，它将 Markdown 代码转换成超文本标记语言。</p>
<p>
在 <em>Request</em> 字段中输入如下的内容：</p>
<pre><code class="sh">## The **OpenFaaS** _workshop_</code></pre>
<p>
现在点击 <em>Invoke</em> ，然后就可以看到响应出现在屏幕的下半部分。</p>
<p>
I.e.</p>
<pre><code class="sh">&lt;h2&gt;The &lt;strong&gt;OpenFaaS&lt;/strong&gt; &lt;em&gt;workshop&lt;/em&gt;&lt;/h2&gt;</code></pre>
<p>
您将会看到如下的字段：</p>
<ul>
  <li>
Status - 函数是否准备好运行。在状态显示就绪之前，您将无法从用户界面调用该函数。  </li>
  <li>
Replicas - 在集群中运行的函数的副本数量。  </li>
  <li>
Image - 发布到 Docker Hub 或 Docker 存储库的 Docker 镜像名称和版本。  </li>
  <li>
Invocation count - 这显示了函数被调用的次数，并且每 5 秒更新一次。  </li>
</ul>
<p>
多次点击 <em>Invoke</em> ，就可以看到 <em>Invocation count</em> 在递增。</p>
<h2>
通过函数商店部署</h2>
<p>
你也可以从 OpenFaaS 商店部署一个函数。这个商店是社区策划的函数集合。</p>
<ul>
  <li>
点击 <em>Deploy New Function</em>  </li>
  <li>
点击 <em>From Store</em>  </li>
  <li>
点击 <em>Figlet</em> 或者在搜索栏里输入 <em>figlet</em> ，然后点击 <em>Deploy</em>  </li>
</ul>
<p>
Figlet 函数将会出现在左侧函数列表中，耐心等几分钟，它需要从 docker hub 下载。 下载完成之后，输入一些文本，然后点击 invoke。</p>
<p>
你会看的一个 ASCII logo：</p>
<pre><code class="sh"> _  ___   ___ _  __
/ |/ _ \ / _ (_)/ /
| | | | | | | |/ /
| | |_| | |_| / /_
|_|\___/ \___/_/(_)</code></pre>
<h2>
学习 CLI</h2>
<p>
你现在可以测试 CLI，但是首先看下网关的 URL：</p>
<p>
如果 gateway 没有部署在<a href="http://127.0.0.1:8080">http://127.0.0.1:8080</a>，你需要按如下的几种方法指定一下：</p>
<ol>
  <li>
设置环境变量<code class="inline">OPENFAAS_URL</code>，<code class="inline">faas-cli</code>将会在 shell 会话中使用这个。比如：<code class="inline">export OPENFAAS_URL=http://openfaas.endpoint.com:8080</code>。这个已经在<a href="./lab1.md">实验 1</a>中设置好了。  </li>
  <li>
使用<code class="inline">-g</code> 或 <code class="inline">--gateway</code>指定正确的端点：<code class="inline">faas deploy --gateway http://openfaas.endpoint.com:8080</code>。  </li>
  <li>
在 YAML 文件中，在<code class="inline">provider:</code>下修改一下<code class="inline">gateway:</code>。  </li>
</ol>
<h3>
列出已经部署的函数</h3>
<p>
这个会显示有多少函数，多少个副本以及调用次数。</p>
<pre><code class="sh">$ faas-cli list</code></pre>
<p>
现在尝试使用 verbose 命令</p>
<pre><code class="sh">$ faas-cli list --verbose</code></pre>
<p>
或</p>
<pre><code class="sh">$ faas-cli list -v</code></pre>
<p>
现在可以在函数旁边看的 Docker 镜像。</p>
<h3>
调用函数</h3>
<p>
选择<code class="inline">faas-cli list</code>中看的的函数，比如 <code class="inline">markdown</code>:</p>
<pre><code class="sh">$ faas-cli invoke markdown</code></pre>
<p>
然后你会被要求输入一些文本，然后按 Control + D 结束。</p>
<p>
或者也可以使用<code class="inline">echo</code> 或 <code class="inline">uname -a</code>作为调用的输入。</p>
<pre><code class="sh">$ echo Hi | faas-cli invoke markdown

$ uname -a | faas-cli invoke markdown</code></pre>
<p>
你甚至可以使用一个 HTML 文件：</p>
<pre><code class="sh">$ git clone https://github.com/openfaas/workshop \
   &amp;&amp; cd workshop

$ cat lab2.md | faas-cli invoke markdown</code></pre>
<h2>
监控面板</h2>
<p>
OpenFaas 使用 Prometheus 监控函数的指标。这些指标可以通过<a href="https://grafana.com">Grafana</a>变成一个可视化的仪表盘。</p>
<p>
在 OpenFaaS 的 Kubernetes 命名空间下运行 Grafana：</p>
<pre><code class="sh">kubectl -n openfaas run \
--image=stefanprodan/faas-grafana:4.6.3 \
--port=3000 \
grafana</code></pre>
<p>
通过 NodePort 暴露：</p>
<pre><code class="sh">kubectl -n openfaas expose pod grafana \
--type=NodePort \
--name=grafana</code></pre>
<p>
找到 Grafana 的 node port 地址</p>
<pre><code class="sh">$ GRAFANA_PORT=$(kubectl -n openfaas get svc grafana -o jsonpath=&quot;{.spec.ports[0].nodePort}&quot;)
$ GRAFANA_URL=http://IP_ADDRESS:$GRAFANA_PORT/dashboard/db/openfaas</code></pre>
<p>
其中 <code class="inline">IP_ADDRESS</code> 就是 Kubernetes 的对应 IP。</p>
<p>
或者你也可以用端口转发命令，这样就可以在<code class="inline">http://127.0.0.1:3000</code>Grafana。</p>
<pre><code class="sh">$ kubectl port-forward pod/grafana 3000:3000 -n openfaas</code></pre>
<p>
如果使用 Kubernetes 1.17 或更高版本，请使用<code class="inline">deploy/grafana</code> ，而不是用 <code class="inline">pod/</code> 。</p>
<p>
创建服务之后，在浏览器中打开 Grafana，然后输入用户名<code class="inline">admin</code> 和密码 <code class="inline">admin</code>登录，并以 <code class="inline">$GRAFANA_URL</code>找到之前已经做好的 OpenFaaS 仪表盘。</p>
<a href="https://camo.githubusercontent.com/24915ac87ecf8a31285f273846e7a5ffe82eeceb/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f4339636145364358554141585f36342e6a70673a6c61726765">&lt;img src=”https://camo.githubusercontent.com/24915ac87ecf8a31285f273846e7a5ffe82eeceb/68747470733a2f2f7062732e7477696d672e636f6d2f6d656469612f4339636145364358554141585f36342e6a70673a6c61726765” width=”600px” /&gt;</a><p>
<em>Pictured: example of an OpenFaaS dashboard with Grafana</em></p>
<p>
现在进入 <a href="./lab3.md">实验 3</a></p>

            </article>
        </div>
    </body>
</html>

    