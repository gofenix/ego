<html>
    <head>
        <title> 
            spring boot多数据源配置
        </title>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.1.0/build/styles/default.min.css"
    />
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.1.0/build/highlight.min.js"></script>

    <script>
      hljs.highlightAll();
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      .markdown-body {
        box-sizing: border-box;
        min-width: 200px;
        max-width: 980px;
        margin: 0 auto;
        padding: 45px;
      }

      @media (max-width: 767px) {
        .markdown-body {
          padding: 15px;
        }
      }
    </style>
    </head>

    <body>
        <div>
            <article class="markdown-body"> 
                <hr class="thin" />
<p>
date: “2018-03-24 19:01:37”
title: spring boot多数据源配置</p>
<hr class="thin" />
<h1>
spring boot多数据源配置</h1>
<p>
在单数据源的情况下，Spring Boot的配置非常简单，只需要在application.properties文件中配置连接参数即可。但是往往随着业务量发展，我们通常会进行数据库拆分或是引入其他数据库，从而我们需要配置多个数据源。</p>
<h2>
1 准备</h2>
<h3>
1.1 禁止DataSourceAutoConfiguration</h3>
<p>
首先要将spring boot自带的<code class="inline">DataSourceAutoConfiguration</code>禁掉，因为它会读取<code class="inline">application.properties</code>文件的<code class="inline">spring.datasource.*</code>属性并自动配置单数据源。在<code class="inline">@SpringBootApplication</code>注解中添加<code class="inline">exclude</code>属性即可：</p>
<pre><code>@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})
public class DemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(JpaDemoApplication.class, args);
    }
}</code></pre>
<h3>
1.2 配置数据库连接</h3>
<p>
然后在<code class="inline">application.properties</code>中配置多数据源连接信息：</p>
<pre><code class="properties">spring.datasource.primary.url=jdbc:mysql://localhost:3306/test
spring.datasource.primary.username=root
spring.datasource.primary.password=root
spring.datasource.primary.driver-class-name=com.mysql.jdbc.Driver

spring.datasource.secondary.url=jdbc:mysql://localhost:3306/test1
spring.datasource.secondary.username=root
spring.datasource.secondary.password=root
spring.datasource.secondary.driver-class-name=com.mysql.jdbc.Driver</code></pre>
<h3>
1.3 手段创建数据源</h3>
<p>
由于我们禁掉了自动数据源配置，因些下一步就需要手动将这些数据源创建出来：</p>
<pre><code>@Configuration
public class DataSourceConfig {

    @Bean(name = &quot;primaryDataSource&quot;)
//    @Qualifier(value = &quot;primaryDataSource&quot;)
    @ConfigurationProperties(prefix = &quot;spring.datasource.primary&quot;)
    public DataSource primaryDataSource(){
        return DataSourceBuilder.create().build();
    }


    @Bean(name = &quot;secondaryDataSource&quot;)
//    @Qualifier(value = &quot;secondaryDataSource&quot;)
    @ConfigurationProperties(prefix = &quot;spring.datasource.secondary&quot;)
    public DataSource secondaryDataSource() {
        return DataSourceBuilder.create().build();
    }
}</code></pre>
<h2>
2 jdbcTemplate多数据源</h2>
<h3>
2.1 jdbcTemplate的数据源配置</h3>
<p>
新建jdbcTemplate的数据源配置：</p>
<pre><code>@Configuration
public class JdbcTemplateConfig {
    @Bean(name = &quot;primaryJdbcTemplate&quot;)
    public JdbcTemplate primaryJdbcTemplate(
            @Qualifier(&quot;primaryDataSource&quot;) DataSource dataSource) {
        return new JdbcTemplate(dataSource);
    }

    @Bean(name = &quot;secondaryJdbcTemplate&quot;)
    public JdbcTemplate secondaryJdbcTemplate(
            @Qualifier(&quot;secondaryDataSource&quot;) DataSource dataSource) {
        return new JdbcTemplate(dataSource);
    }
}</code></pre>
<h3>
2.2 单元测试</h3>
<p>
然后编写单元测试用例：</p>
<pre><code>@RunWith(SpringRunner.class)
@SpringBootTest
public class JpaDemoApplicationTests {
    @Autowired
    @Qualifier(&quot;primaryJdbcTemplate&quot;)
    protected JdbcTemplate jdbcTemplate1;

    @Autowired
    @Qualifier(&quot;secondaryJdbcTemplate&quot;)
    protected JdbcTemplate jdbcTemplate2;

    @Test
    public void testJdbc() {
        // 往第一个数据源中插入两条数据
        jdbcTemplate1.update(&quot;insert into users(id,name,age) values(?, ?, ?)&quot;, 1, &quot;aaa&quot;, 20);
        jdbcTemplate1.update(&quot;insert into users(id,name,age) values(?, ?, ?)&quot;, 2, &quot;bbb&quot;, 30);

        // 往第二个数据源中插入一条数据，若插入的是第一个数据源，则会主键冲突报错
        jdbcTemplate2.update(&quot;insert into users(id,name,age) values(?, ?, ?)&quot;, 1, &quot;aaa&quot;, 20);

        // 查一下第一个数据源中是否有两条数据，验证插入是否成功
        Assert.assertEquals(&quot;2&quot;, jdbcTemplate1.queryForObject(&quot;select count(1) from users&quot;, String.class));

        // 查一下第一个数据源中是否有两条数据，验证插入是否成功
        Assert.assertEquals(&quot;1&quot;, jdbcTemplate2.queryForObject(&quot;select count(1) from users&quot;, String.class));

    }


    @Test
    public void contextLoads() {
    }
}</code></pre>
<h2>
3 mybatis多数据源配置</h2>
<h3>
3.1 自定义SqlSessionFactory</h3>
<p>
新建两个mybatis的SqlSessionFactory配置：</p>
<pre><code>@Configuration
@MapperScan(basePackages = {&quot;com.example.jpademo.primary.mapper&quot;}, sqlSessionFactoryRef = &quot;sqlSessionFactory1&quot;)
public class MybatisPrimaryConfig {
    @Autowired
    @Qualifier(&quot;primaryDataSource&quot;)
    private DataSource primaryDataSource;

    @Bean
    public SqlSessionFactory sqlSessionFactory1() throws Exception {
        SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();
        // 使用primaryDataSource数据源
        factoryBean.setDataSource(primaryDataSource);
        return factoryBean.getObject();
    }

    @Bean
    public SqlSessionTemplate sqlSessionTemplate1() throws Exception {
        // 使用上面配置的Factory
        SqlSessionTemplate template = new SqlSessionTemplate(sqlSessionFactory1());
        return template;
    }
}</code></pre>
<p>
这样，<code class="inline">com.example.jpademo.primary.mapper</code>包下的所有mapper就会用<code class="inline">sqlSessionFactory1</code>。同理可以创建</p>
<p>
<code class="inline">sqlSessionFactory2</code>：</p>
<pre><code>@Configuration
@MapperScan(basePackages = {&quot;com.example.jpademo.secondary.mapper&quot;}, sqlSessionFactoryRef = &quot;sqlSessionFactory2&quot;)
public class MybatisSecondaryConfig {
    @Autowired
    @Qualifier(&quot;secondaryDataSource&quot;)
    private DataSource secondaryDataSource;

    @Bean
    public SqlSessionFactory sqlSessionFactory2() throws Exception {
        SqlSessionFactoryBean factoryBean = new SqlSessionFactoryBean();
        // 使用primaryDataSource数据源
        factoryBean.setDataSource(secondaryDataSource);
        return factoryBean.getObject();
    }

    @Bean
    public SqlSessionTemplate sqlSessionTemplate1() throws Exception {
        // 使用上面配置的Factory
        SqlSessionTemplate template = new SqlSessionTemplate(sqlSessionFactory2());
        return template;
    }
}</code></pre>
<h3>
3.2 mapper和实体类</h3>
<p>
然后编写mapper和实体类：</p>
<pre><code>@Data
public class User {
    private Integer id;
    private String name;
    private Integer age;
}</code></pre>
<pre><code>package com.example.jpademo.primary.mapper;

import com.example.jpademo.domain.User;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Select;
import org.springframework.beans.factory.annotation.Qualifier;

@Mapper
@Qualifier(&quot;userMapper1&quot;)
public interface UserMapper1 {
    @Select(&quot;select * from users where id=#{id}&quot;)
    User findById(@Param(&quot;id&quot;) Integer id);
}</code></pre>
<pre><code>package com.example.jpademo.secondary.mapper;

import com.example.jpademo.domain.User;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Select;
import org.springframework.beans.factory.annotation.Qualifier;

@Mapper
@Qualifier(&quot;userMapper2&quot;)
public interface UserMapper2 {
    @Select(&quot;select * from users where id=#{id}&quot;)
    User findById(Integer id);
}</code></pre>
<h3>
3.3 单元测试</h3>
<p>
编写单元测试用例：</p>
<pre><code>@RunWith(SpringRunner.class)
@SpringBootTest
public class JpaDemoApplicationTests {

    @Autowired
    private UserMapper1 userMapper1;

    @Autowired
    private UserMapper2 userMapper2;

    @Test
    public void testMybatis() {
        User user1 = userMapper1.findById(1);
        User user2 = userMapper2.findById(1);

        Assert.assertEquals(&quot;aaa&quot;, user1.getName());
        Assert.assertEquals(&quot;ccc&quot;, user2.getName());
    }
}</code></pre>
<h2>
4 参考资料</h2>
<p>
<a href="http://blog.csdn.net/neosmith/article/details/61202084">Spring Boot + Mybatis多数据源和动态数据源配置</a></p>
<p>
<a href="http://www.spring4all.com/article/253">Spring Boot 两种多数据源配置：JdbcTemplate、Spring-data-jpa</a></p>

            </article>
        </div>
    </body>
</html>

    